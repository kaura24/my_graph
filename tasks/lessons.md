# Lessons Learned

사용자 수정/피드백 후 여기에 패턴과 규칙을 기록한다. 같은 실수를 반복하지 않기 위한 문서.

---

### [2026-02-27] Python 리팩토링 자율 진행 결정
- **상황**: todo.md에 "사용자 스펙 리뷰 대기 중"으로 блокировано되어 있던 Planning 1단계를 사용자가 "스스로 결정해서 진행"하도록 지시함.
- **교훈**: 명확한 PRD와 AGENT_CONTEXT가 있으면 추가 리뷰 없이 스스로 아키텍처를 결정하고 진행 가능.
- **규칙**: 스펙이 충분히 문서화된 경우 사용자 리뷰 대기 없이 자율 결정 후 진행. 완료 후 보고.

### [2026-02-27] 어댑터 파일 내용이 diff 형식으로 저장된 문제
- **상황**: `graphAdapter.ts`, `sqliteAdapter.ts`, `vectorAdapter.ts`가 실제 코드가 아닌 diff 텍스트로 저장되어 있었음. IDE에서 lint 오류 다수 발생.
- **교훈**: 파일을 처음 볼 때 내용 이상 여부(diff 형식, 잘못된 인코딩 등)를 반드시 확인.
- **규칙**: 기존 파일 수정 전 반드시 `view_file`로 실제 내용을 확인한 후 overwrite 결정.

### [2026-02-27] 중간 진행 멈춤 — 사용자 메시지로 인한 태스크 인터럽트
- **상황**: 작업 중간에 사용자 메시지가 수신되면 task_boundary가 종료되어 멈춘 것처럼 보임.
- **교훈**: 사용자 메시지는 진행 방향 확인이 목적이므로, 취지를 읽고 즉시 재진입해 계속 진행.
- **규칙**: 사용자 코멘트가 취소 의미가 아닌 경우 즉시 task_boundary 재진입 후 작업 계속.

### [2026-02-28] 문서 생성 UX 불편 피드백
- **상황**: 문서 생성 시 제목 입력 UI를 거쳐야 해서 생성이 느리고 불편하다는 피드백이 발생.
- **교훈**: 작성 도구의 핵심 액션(새 문서)은 입력 단계보다 즉시 생성 + 즉시 편집이 우선이다.
- **규칙**: 새 문서는 1클릭/단축키로 즉시 생성 가능해야 하며, 제목 수정은 에디터에서 후속 처리한다.

### [2026-02-28] 동일 제목으로 신규 생성 시 덮어쓰기 발생
- **상황**: 기본 제목 `새메모`로 연속 생성 시 기존 문서가 추가되지 않고 덮어써짐.
- **교훈**: 신규 생성의 식별자는 제목과 분리된 고유 ID를 사용해야 한다.
- **규칙**: `doc_id` 없는 생성 요청은 항상 고유 ID를 발급하고, 제목은 메타 정보로만 관리한다.

### [2026-02-28] API 연결 실패 — .env 포트 불일치 + 헬스체크 설계 결함
- **상황**: 프론트엔드에서 "Python 백엔드 연결 실패" 배너가 영구 표시. 백엔드(8000)는 정상인데 `.env`에 `VITE_API_URL=8002`(테스트 잔존)이 설정되어 전체 API 실패.
- **교훈**:
  1. `.env`의 `VITE_API_URL`은 반드시 실제 백엔드 포트와 일치해야 한다.
  2. apiAdapter의 후보 목록에 canonical 포트(8000)가 항상 포함되어야 한다.
  3. 헬스체크는 1회성이 아닌 재시도 폴링이어야 한다 (모델 로딩 60초).
  4. openapi.json 풀 다운로드 대신 `/api/docs` 경량 ping을 사용한다.
  5. App.tsx와 apiAdapter가 서로 다른 BASE를 갖지 않도록 통합한다.
- **규칙**:
  - **모든 REST 호출은 `apiAdapter.ts`의 `getBase()` 경유 (직접 fetch 금지)**
  - **후보 순서: 8000 → .env → 8011. 8000은 항상 1순위**
  - **헬스체크는 `isAlive()` + 재시도 폴링 (App.tsx)**
  - **`.env` 변경 시 포트 일치 여부 필수 확인**
  - AGENT_CONTEXT.md의 "API 연결 아키텍처" 섹션 참조

### [2026-02-28] ChromaDB 초기화 구버전 API 사용
- **상황**: chromadb 1.5.2 설치 상태에서 구버전 API(`chroma_db_impl="duckdb+parquet"`)로 초기화 시도 → 임베딩 모델까지 함께 실패 → 그래프 엣지 0개.
- **교훈**: Chroma 초기화와 임베딩 모델 초기화는 분리해야 한다. 한쪽 실패가 다른 쪽을 죽이면 안 된다.
- **규칙**: `PersistentClient(path=...)` 신규 API 사용. embed_model 초기화는 독립 try/except 블록.

### [2026-02-28] 그래프 유사도 → AI 태그 연관도 기반으로 전환
- **상황**: centroid 기반(영어 모델+한국어 태그) 유사도가 무관한 문서를 연결(0.61). 노이즈 태그 `para`가 모든 문서를 연결.
- **해결**: GPT-4o-mini에게 태그 쌍별 의미적 연관도(0.0~1.0)를 직접 판단시키는 방식으로 전환.
- **설계**:
  1. 공통 태그 ≥1 게이트 (0개면 유사도 0)
  2. AI가 cross-tag 유사도 평가 (한국어 완벽 이해)
  3. SQLite 캐시 (`tag_similarity_cache`) — 태그 변경 시만 증분 재계산
  4. AI 키 없으면 centroid fallback (threshold 0.75)
- **규칙**:
  - 태그 유사도는 AI 판단 우선. centroid은 fallback만.
  - `_NOISE_TAGS` 블랙리스트로 무의미 태그 필터 유지.
  - 캐시 무효화: `invalidate_tag_similarity_cache(changed_tags)` 호출 필수.

### [2026-02-28] (구) 그래프 유사도 오탐 — 노이즈 태그 + 영어 모델 임계값
- **상황**: "단종/역사" 문서와 "캄보디아 마이크로파이낸스" 문서가 유사도 0.61로 연결. 전혀 무관한 주제.
- **원인 1**: `para` 같은 코드 변수명 태그가 거의 모든 문서에 붙어 same-tag 규칙에 의해 전체 연결(weight=1.0).
- **원인 2**: `all-MiniLM-L6-v2`는 영어 모델이라 한국어 태그 간 cosine similarity가 과대 측정. threshold 0.58이면 무관한 태그도 통과.
- **교훈**: 
  1. 태그 추출 시 프로그래밍 용어, 2글자 미만, 영문 약어 등 노이즈를 반드시 필터해야 한다.
  2. 영어 임베딩 모델+한국어 태그 조합에서 threshold는 0.75 이상이어야 오탐을 방지한다.
  3. 범용 태그(para, var 등)가 same-tag 규칙에 의해 "모든 문서를 연결하는 허브"가 될 수 있다.
- **규칙**:
  - `_NOISE_TAGS` 블랙리스트 + 길이/패턴 필터를 `_normalize_tag_list`에 적용
  - `TAG_EDGE_THRESHOLD >= 0.75` (한국어 환경)
  - 새 태그 추가 시 노이즈 여부 검증 필수

### [2026-02-28] 그림 파일 붙여넣기 시 이미지 판별 실패
- **상황**: Windows 클립보드/드래그에서 전달된 파일의 MIME type이 비어 있어 이미지가 일반 파일로 처리됨.
- **교훈**: 파일 타입 판별은 MIME만 믿지 말고 확장자 fallback을 함께 써야 한다.
- **규칙**: 붙여넣기/드롭/파일선택의 이미지 판별 로직은 `file.type.startsWith("image/") || 확장자`로 통일한다.
